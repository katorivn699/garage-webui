name: Build & Release for Termux

# Action sẽ chạy khi bạn push một tag bắt đầu bằng 'v' (ví dụ: v1.0.1)
on:
  push:
    tags:
      - "v*"

permissions:
  contents: write # Cấp quyền để Action có thể tạo Release

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # --- PHẦN 1: BUILD FRONTEND ---
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm' # hoặc 'pnpm' nếu project dùng pnpm

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Build Frontend
        run: |
          pnpm install
          pnpm build
        # Sau bước này, folder 'dist' sẽ được tạo ra

      # --- PHẦN 2: BUILD BACKEND (GO) ---
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Build Binary for Termux (Linux ARM64)
        env:
          GOOS: linux
          GOARCH: arm64
          CGO_ENABLED: 0 # Quan trọng: Build static binary để chạy mọi nơi không cần thư viện lạ
        run: |
          cd backend
          go build -o garage-webui-termux-arm64 main.go
          
      # --- PHẦN 3: TẠO RELEASE ---
      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: backend/garage-webui-termux-arm64
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
